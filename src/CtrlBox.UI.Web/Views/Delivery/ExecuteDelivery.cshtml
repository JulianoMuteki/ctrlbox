
@{
    ViewData["Title"] = "ExecuteDelivery";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section scriptsViews
    {
    <partial name="~/Views/PartialsSections/_ScriptsTable.cshtml" />
}
<script type="text/javascript">
            @{ var entregaID = ViewData["entregaID"];
                var linhaID = ViewData["linhaID"];
            }
    function handleAjaxError(xhr, textStatus, error) {

        $('#example').dataTable({
            "bDestroy": true,
            "bProcessing": false
        });

        if (textStatus === 'timeout') {
            alert('The server took too long to send the data.');
        }
        else {
            var obj = $.parseJSON(xhr.responseText);
            alert(obj.Message);
            alert("É necessário atualizar a página");
        }

        return false;
    }

    Number.prototype.formatMoney = function (places, symbol, thousand, decimal) {
        places = !isNaN(places = Math.abs(places)) ? places : 2;
        symbol = symbol !== undefined ? symbol : "R$ ";
        thousand = thousand || ".";
        decimal = decimal || ",";
        var number = this,
            negative = number < 0 ? "-" : "",
            i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
            j = (j = i.length) > 3 ? j % 3 : 0;
        return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
    };


    function loadTable() {

         var url = '@Url.Content("~/Delivery/AjaxHandlerExecutarEntrega")?entregaID=' + '@entregaID';

        var oTable = $('#tbClientes').dataTable({
            "sPaginationType": "full_numbers",
            "sAjaxSource": url,
            "bProcessing": true,
            "bAutoWidth": false,
            "bDestroy": true,
            "aoColumns": [
                    {
                        "mData": "Name"
                    },
                    {
                        "mData": "Address"
                    },
                    {
                        "mData": "Phone"
                    },
                    {
                        "mData": "Contact"
                    },
                    {
                        "mData": null,
                        "sType": "html",
                        "bSortable": false,
                        sClass: "calc",
                        "mRender": function (data, type, row) {
                            if (type === 'display') {

                                if (row.StatusEntrega) {
                                    return '';
                                }
                                else {
                                     var url = '@Url.Action("Index", "Sale")?clienteID=' + row.DT_RowId + '&linhaID=' + '@linhaID' + '&entregaID=' + '@entregaID';
                                    return '<a href="' + url + '" class="btn mini"><i class="icon-shopping-cart"></i> View</a>';
                                }
                            }
                            return data;
                        }
                    },
                    {
                        "mData": null,
                        "sType": "html",
                        "bSortable": false,
                        "mRender": function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                var status = 'warning';
                                var texto = "Pendente";

                                if (row.IsDelivery) {
                                    status = 'success';
                                    texto = "Entregue"
                                }

                                return '<span class="label label-' + status + '">' + texto + '</span>';
                            }
                            return data;
                        }
                    }
            ],
            "fnServerData": function (sSource, aoData, fnCallback, oSettings) {
                oSettings.jqXHR = $.ajax({
                    "dataType": 'json',
                    "type": "POST",
                    "url": sSource,
                    "data": aoData,
                    "success": function (json) {
                        if (!json.NotAuthorized) {
                            var obj = $.parseJSON(JSON.stringify(json));

                            $('#qtdeEntrega').DataTable({
                                "data": obj.xaData,
                                "bPaginate": false,
                                "bAutoWidth": false,
                                bFilter: false, bInfo: false,

                                "aoColumns": [
                                                   {
                                                       "mData": "Name",
                                                       "bSortable": false
                                                   },
                                                 {
                                                     "mData": "Amount",
                                                     "bSortable": false
                                                 }]
                            });

                            $('#tbDespesas').dataTable({
                                "data": obj.xbData,
                                "bPaginate": false,
                                "bAutoWidth": false,
                                bFilter: false, bInfo: false,
                                "aoColumns": [
                                                  {
                                                      "mData": "Description",
                                                      data: null,
                                                      "bSortable": false
                                                  },
                                                   {
                                                       "mData": "Value",
                                                       "bSortable": false
                                                   }]
                            });
                        }
                        fnCallback(json);
                    },
                    "error": handleAjaxError
                });
            }
        });
    }
    jQuery(document).ready(function () {

         @*var url = '@Url.Content("~/Delivery/AjaxHandlerExecutarEntrega")?entregaID=' + '@entregaID';

        $.ajax({
            url: url,
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            dataType: 'JSON',
            "error": handleAjaxError,
            complete: function (xhr, status) {
                if (status === 'error' || !xhr.responseText) {
                    alert(status);
                }
                else {
                    var output = JSON.parse(xhr.responseText);
                    loadTable(output);
                }
            }
        });*@

        loadTable();
        var rowID = 0;
        //Salva linha de cheque
        $("#target").click(function (event) {

            var tb = $('#tbDespesas').DataTable();
            var rowADD = {
                // "DT_RowId": rowID + 1,
                "Descricao": $("#numeroCheque").val(),
                "Valor": $("#mask_currency").val().replace(/[^0-9\,]+/g, "").replace(",", ".")
            };
            tb.row.add(rowADD).draw();
            var desc = $("#numeroCheque").val();
            var val = $("#mask_currency").val().replace(/[^0-9\,]+/g, "").replace(",", ".");

            $.ajax({
                url: '@Url.Content("~/Delivery/SubmitDespesa")',
                type: 'POST',
                dataType: 'json',
                // contentType: "application/json",
                data: { entregaID: '@entregaID', descricao : desc, valor : val },
                "success": function (json) {
                    if (!json.NotAuthorized) {
                        alert('Completo');

                        $("#btnClose").trigger("click");
                    }
                },
                "error": handleAjaxError
            });
        });

        //Seleciona uma linha de cheque para excluir
        $('#tbDespesas tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');
            }
            else {
                var tb = $('#tbDespesas').DataTable();
                tb.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
            }
        });

        //Exclui linha de cheque
        $('#deleteRow').click(function () {
            var tb = $('#tbDespesas').DataTable();
            tb.row('.selected').remove().draw(false);
        });


    });
</script>

<div class="page-content">
    <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
    <div id="portlet-config" class="modal hide">

        <div class="modal-body">
            <!-- BEGIN FORM-->

            <h3 class="form-section">Cadastro de cheque</h3>
            <div class="row-fluid">
                <div class="span6 ">
                    <div class="control-group">
                        <label class="control-label" for="numeroCheque">Número do cheque</label>
                        <div class="controls">


                            <textarea id="numeroCheque" class="medium m-wrap" rows="3"></textarea>

                        </div>
                    </div>
                </div>
                <!--/span-->
                <!--/span-->
            </div>
            <!--/row-->
            <div class="row-fluid">
                <div class="span6 ">
                    <div class="control-group">
                        <label class="control-label">Valor</label>
                        <div class="controls">
                            <input class="span6 m-wrap" id="mask_currency" type="text" />
                            <span class="help-inline">Ex.: R$ 9.999.999,00</span>
                        </div>
                    </div>
                </div>

            </div>
            <!--/row-->

            <div class="modal-footer">
                <button type="button" id="btnClose" data-dismiss="modal" class="btn">Close</button>
                <button type="button" id="target" class="btn blue">Save changes</button>
            </div>

            <!-- END FORM-->
        </div>

    </div>
    <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
    <!-- BEGIN PAGE CONTAINER-->
    <div class="container-fluid">
        <!-- BEGIN PAGE HEADER-->
        <div class="row-fluid">
            <div class="span12">

                <!-- BEGIN PAGE TITLE & BREADCRUMB-->
                <h3 class="page-title">
                    Executar entrega<small> entregas a serem feitas</small>
                </h3>
                <ul class="breadcrumb">
                    <li>
                        <i class="icon-home"></i>
                        <a href="index.html">Home</a>
                        <i class="icon-angle-right"></i>
                    </li>
                    <li>
                        <a href="#">Data Tables</a>
                        <i class="icon-angle-right"></i>
                    </li>
                    <li><a href="#">Basic Tables</a></li>
                </ul>
                <!-- END PAGE TITLE & BREADCRUMB-->
            </div>

        </div>
        <!-- END PAGE HEADER-->
        <!--Begin Info linha-->
        <div class="row-fluid">
            <div class="span12">
                <div class="alert alert-success">
                    <button class="close" data-dismiss="alert"></button>
                    Os mercados já estão lista na ordem de entrega.<br>
                    <span class="label label-important">NOTE:</span>&nbsp;Favor entregar na ordem estabelecida
                </div>

            </div>

        </div>
        <!-- BEGIN PAGE CONTENT-->
        <div class="row-fluid">

            <div class="span8">
                <!-- BEGIN SAMPLE TABLE PORTLET-->
                <div class="portlet box red">
                    <div class="portlet-title">
                        <div class="caption"><i class="icon-cogs"></i>Clientes</div>

                    </div>
                    <div class="portlet-body">
                        <table id="tbClientes" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Endereço</th>
                                    <th class="hidden-480">Telefone</th>
                                    <th>Contato</th>
                                    <th>Vender</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- END SAMPLE TABLE PORTLET-->
            </div>

        </div>

        <div class="row-fluid">

            <div class="span4">
                <!-- BEGIN SAMPLE TABLE PORTLET-->
                <div class="portlet box yellow">
                    <div class="portlet-title">
                        <div class="caption"><i class="icon-cogs"></i>Despesas</div>
                        <div class="actions">
                            <a href="#portlet-config" data-toggle="modal" class="config btn gray"><i class="icon-plus"></i> Add</a>
                            <a id="deleteRow" class="btn"><i class="icon-remove"></i> Remover</a>
                        </div>
                    </div>
                    <div class="portlet-body">
                        <table id="tbDespesas" class="table table-hover">
                            <thead>
                                <tr>

                                    <th>Descrição</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- END SAMPLE TABLE PORTLET-->
            </div>
            <div class="span4">
                <!-- BEGIN SAMPLE TABLE PORTLET-->
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption"><i class="icon-cogs"></i>Carregado no caminhão</div>

                    </div>
                    <div class="portlet-body">
                        <table id="qtdeEntrega" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>

                                <tr>
                                    <td>10,80</td>
                                    <td>Almoço</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- END SAMPLE TABLE PORTLET-->
            </div>

        </div>
        <!-- END PAGE CONTENT-->
    </div>
    <!-- END PAGE CONTAINER-->
</div>

