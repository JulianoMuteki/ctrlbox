@model CtrlBox.Application.ViewModel.RouteVM

@{
    ViewData["Title"] = "Home Page";
}

<script type="text/javascript">
    @{
                var routeID = ViewData["routeID"];
            }
    function handleAjaxError(xhr, textStatus, error) {

        $('#example').dataTable({
            "bDestroy": true,
            "bProcessing": false
        });

        if (textStatus === 'timeout') {
            alert('The server took too long to send the data.');
        }
        else {
            var obj = $.parseJSON(xhr.responseText);
            alert(obj.Message);
            alert("É necessário atualizar a página");
        }

        return false;
    }

    function carregarTabela(id, url) {

        var oTable = $(id).dataTable({
            "sAjaxSource": url,
            "bProcessing": true,
            "bDestroy": true,
            "aoColumns": [
                            {
                                "mData": "Name"
                            },
                            {
                                "mData": "Address"
                            },
                            {
                                "mData": "Phone"
                            },
                            {
                                "mData": null,
                                "sType": "html",
                                "mRender": function (data, type, row) {
                                    if (type === 'display') {
                                        return '<input type="checkbox" name="ClienteID" value="' + row.DT_RowId + '">';
                                    }
                                    return data;
                                }
                            }
            ],
            "aLengthMenu": [
                [5, 15, 20, -1],
                [5, 15, 20, "All"] // change per page values here
            ],
            // set the initial value
            "iDisplayLength": 5,
            "sDom": "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
            "sPaginationType": "bootstrap",
            "oLanguage": {
                "sLengthMenu": "_MENU_ records per page",
                "oPaginate": {
                    "sPrevious": "Prev",
                    "sNext": "Next"
                }
            },
            "aoColumnDefs": [{
                'bSortable': false,
                'aTargets': [0]
            }
            ],
            "fnServerData": function (sSource, aoData, fnCallback, oSettings) {
                oSettings.jqXHR = $.ajax({
                    "dataType": 'json',
                    "type": "POST",
                    "url": sSource,
                    "data": aoData,
                    "success": function (json) {
                        if (!json.NotAuthorized) {
                            //  var obj = $.parseJSON(JSON.stringify(json));
                        }
                        fnCallback(json);
                    },
                    "error": handleAjaxError
                });
            }
        });

        return oTable;
    }

    function carregarTabelas(linhaID) {

        var urlClientesDisponiveis = '@Url.Content("~/Route/AjaxHandlerClientesDisponiveis")?routeID=' + '@routeID';
        carregarTabela('#tbAdicionar', urlClientesDisponiveis);

        var urlClientesNaoDisponiveis = '@Url.Content("~/Route/AjaxHandlerClientesNaoDisponiveis")?routeID=' + '@routeID';
        carregarTabela('#tbRemover', urlClientesNaoDisponiveis);
    }

    (function ($) {
        $.fn.serializeFormJSON = function () {
            var lista = [];
            var a = this.serializeArray();
            $.each(a, function () {
                lista.push({ "ClientID": this.value, "RouteID": '@routeID' });
            });
            return JSON.stringify(lista);
        };
    })(jQuery);

    jQuery(document).ready(function () {
        carregarTabelas('@routeID');

        $('#btnSubmitAdicionar').click(function () {
            var oTableAdicionar = $('#tbAdicionar').dataTable();
            var data = $(oTableAdicionar.$("input[name='ClienteID']:checked")).serializeFormJSON();

            $.ajax({
                url: '@Url.Content("~/Route/SubmitAdicionarClientes")',
                type: 'POST',
                dataType: 'json',
                data: { linhaID: '@routeID', clientesIDs: data },
                "success": function (json) {
                    if (!json.NotAuthorized) {
                        alert('Completo');
                        carregarTabelas('@routeID');
                    }
                }
            });

           return false;
        });

        $('#btnSubmitRemover').click(function () {
            var oTableRemover = $('#tbRemover').dataTable();
            var sData = $('input', oTableRemover.fnGetNodes()).serialize();
            $.ajax({
                url: '@Url.Content("~/Route/SubmitRemoverClientes")',
                type: 'POST',
                dataType: 'json',
                data: { routeID: '@routeID', clientesIDs: sData },
                "success": function (json) {
                    if (!json.NotAuthorized) {
                        alert('Completo');
                        carregarTabelas('@routeID');
                    }
                }
            });
            return false;
        });
    });
</script>

<div class="page-content">
    <!-- BEGIN PAGE CONTAINER-->
    <div class="container-fluid">
        <!-- BEGIN PAGE HEADER-->
        <div class="row-fluid">
            <div class="span12">

                <!-- BEGIN PAGE TITLE & BREADCRUMB-->
                <h3 class="page-title">
                    <small>   Vinclular clientes a linha:</small>@Model.Name
                </h3>
                <ul class="breadcrumb">
                    <li>
                        <i class="icon-home"></i>
                        <a href="index.html">Home</a>
                        <i class="icon-angle-right"></i>
                    </li>
                    <li>
                        <a href="#">Data Tables</a>
                        <i class="icon-angle-right"></i>
                    </li>
                    <li><a href="#">Basic Tables</a></li>
                </ul>
                <!-- END PAGE TITLE & BREADCRUMB-->
            </div>

        </div>
        <!-- END PAGE HEADER-->
        <!-- BEGIN PAGE CONTENT-->
        <div class="row-fluid">

            <div class="span6">
                <!-- BEGIN SAMPLE TABLE PORTLET-->
                <div class="portlet box green">
                    <div class="portlet-title">
                        <div class="caption"><i class="icon-cogs"></i>Clientes disponíveis</div>

                    </div>
                    <div class="portlet-body">
                        <form id="form">
                            <table id="tbAdicionar" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome</th>

                                        <th class="hidden-480">Telefone</th>
                                        <th>Telefone</th>
                                        <th>Vender</th>

                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </form>
                        <a href="#" id="btnSubmitAdicionar" class="btn green"><i class="icon-plus"></i>Adicionar</a>

                    </div>
                </div>
                <!-- END SAMPLE TABLE PORTLET-->

            </div>
            <div class="span6">
                <!-- BEGIN SAMPLE TABLE PORTLET-->
                <div class="portlet box red">
                    <div class="portlet-title">
                        <div class="caption"><i class="icon-cogs"></i>Clientes desta linha</div>

                    </div>
                    <div class="portlet-body">
                        <form id="form">
                            <table id="tbRemover" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome</th>

                                        <th class="hidden-480">Telefone</th>
                                        <th>Telefone</th>
                                        <th>Vender</th>

                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </form>
                        @if (!Model.HasOpenDelivery)
                        {
                            <a href="#" id="btnSubmitRemover" class="btn red"><i class="icon-trash"></i>Remover</a>
                        }
                        else
                        {
                            <div class="alert">

                                <strong>Warning!</strong> Existe uma entrega em aberto.
                            </div>
                        }
                    </div>
                </div>
                <!-- END SAMPLE TABLE PORTLET-->

            </div>

        </div>

        <!-- END PAGE CONTENT-->
    </div>
    <!-- END PAGE CONTAINER-->
</div>